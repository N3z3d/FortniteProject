package com.fortnite.pronos.controller;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.stream.Collectors;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.Valid;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import com.fortnite.pronos.core.usecase.CreateGameUseCase;
import com.fortnite.pronos.core.usecase.JoinGameUseCase;
import com.fortnite.pronos.dto.CreateGameRequest;
import com.fortnite.pronos.dto.DraftDto;
import com.fortnite.pronos.dto.GameDto;
import com.fortnite.pronos.dto.JoinGameRequest;
import com.fortnite.pronos.exception.GameFullException;
import com.fortnite.pronos.exception.GameNotFoundException;
import com.fortnite.pronos.exception.InvalidGameStateException;
import com.fortnite.pronos.model.User;
import com.fortnite.pronos.repository.UserRepository;
import com.fortnite.pronos.service.FlexibleAuthenticationService;
import com.fortnite.pronos.service.GameService;
import com.fortnite.pronos.service.ValidationService;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.ExampleObject;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Tag(name = "Games", description = "Fantasy league game management and participation")
@Slf4j
@RestController
@RequestMapping("/api/games")
@RequiredArgsConstructor
public class GameController {

  private final GameService gameService;
  private final ValidationService validationService;
  private final FlexibleAuthenticationService flexibleAuthenticationService;
  private final UserRepository userRepository;
  private final com.fortnite.pronos.service.JwtService jwtService;

  private final CreateGameUseCase createGameUseCase;
  private final JoinGameUseCase joinGameUseCase;

  @Operation(
      summary = "Create a new fantasy league game",
      description = "Creates a new fantasy league game with specified configuration",
      security = @SecurityRequirement(name = "bearerAuth"))
  @ApiResponses(
      value = {
        @io.swagger.v3.oas.annotations.responses.ApiResponse(
            responseCode = "201",
            description = "Game created successfully",
            content =
                @Content(
                    mediaType = "application/json",
                    schema = @Schema(implementation = GameDto.class),
                    examples =
                        @ExampleObject(
                            name = "Successful game creation",
                            value =
                                """
                    {
                      "id": "550e8400-e29b-41d4-a716-446655440000",
                      "name": "Championship League 2025",
                      "status": "CREATING",
                      "maxParticipants": 10,
                      "currentParticipants": 1,
                      "createdBy": "john.doe"
                    }
                    """))),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(
            responseCode = "400",
            description = "Invalid request data",
            content =
                @Content(
                    mediaType = "application/json",
                    examples =
                        @ExampleObject(
                            name = "Validation error",
                            value =
                                """
                    {
                      "success": false,
                      "message": "Validation failed"
                    }
                    """))),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(
            responseCode = "401",
            description = "Authentication required",
            content =
                @Content(
                    mediaType = "application/json",
                    examples =
                        @ExampleObject(
                            value =
                                """
                    {
                      "success": false,
                      "message": "Authentication required"
                    }
                    """)))
      })
  @PostMapping
  public ResponseEntity<GameDto> createGame(
      @Parameter(
              description = "Game creation request with name, settings, and region rules",
              required = true,
              schema = @Schema(implementation = CreateGameRequest.class))
          @Valid
          @RequestBody
          CreateGameRequest request,
      @RequestParam(name = "user", required = false) String username,
      HttpServletRequest httpRequest) {
    log.info("Creation d'une nouvelle game: {}", request.getName());

    try {
      User user = resolveUser(username, true, httpRequest);
      if (user == null) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
      }
      UUID creatorId = request.getCreatorId() != null ? request.getCreatorId() : user.getId();
      request.setCreatorId(creatorId);

      GameDto createdGame = createGameUseCase.execute(creatorId, request);
      return ResponseEntity.status(HttpStatus.CREATED).body(createdGame);
    } catch (IllegalArgumentException | jakarta.validation.ConstraintViolationException e) {
      log.warn("Validation error while creating game: {}", e.getMessage());
      return ResponseEntity.badRequest().build();
    } catch (Exception e) {
      log.error("Erreur lors de la creation de la game", e);
      return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
    }
  }

  @Operation(
      summary = "Get game details by ID",
      description =
          """
        Retrieves detailed information about a specific fantasy league game.
        """,
      security = @SecurityRequirement(name = "bearerAuth"))
  @ApiResponses(
      value = {
        @io.swagger.v3.oas.annotations.responses.ApiResponse(
            responseCode = "200",
            description = "Game details retrieved successfully",
            content =
                @Content(
                    mediaType = "application/json",
                    schema = @Schema(implementation = GameDto.class),
                    examples =
                        @ExampleObject(
                            name = "Game details response",
                            value =
                                """
                    {
                      "id": "550e8400-e29b-41d4-a716-446655440000",
                      "name": "Championship League 2025",
                      "status": "DRAFTING",
                      "maxParticipants": 10,
                      "currentParticipants": 8
                    }
                    """))),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(
            responseCode = "404",
            description = "Game not found"),
        @io.swagger.v3.oas.annotations.responses.ApiResponse(
            responseCode = "401",
            description = "Authentication required")
      })
  @GetMapping("/{id}")
  public ResponseEntity<GameDto> getGameById(
      @PathVariable UUID id,
      @RequestParam(name = "user", required = false) String userParam,
      HttpServletRequest httpRequest) {
    log.debug("Recuperation de la game: {} (user param: {})", id, userParam);

    User caller = resolveUser(userParam, false, httpRequest);
    if (caller == null) {
      return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
    }
    try {
      GameDto gameDto = gameService.getGameByIdOrThrow(id);
      return ResponseEntity.ok(gameDto);
    } catch (GameNotFoundException e) {
      log.warn("Game non trouvee: {}", id);
      return ResponseEntity.notFound().build();
    } catch (Exception e) {
      log.error("Erreur lors de la recuperation de la game", e);
      return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
    }
  }

  /** Liste toutes les games, avec filtre optionnel par utilisateur. */
  @GetMapping
  public ResponseEntity<List<GameDto>> getAllGames(
