<div class="team-detail-container" *ngIf="team; else loadingOrError">
  <!-- Hero Section -->
  <header class="team-hero">
    <div class="hero-content">
      <div class="team-badge">
        <span class="initial">{{ team.name.charAt(0).toUpperCase() }}</span>
      </div>
      <div class="team-info">
        <div class="team-meta">
          <span class="season-badge">{{ t.t('teams.common.season') }} {{ team.season }}</span>
          <span class="owner-badge">
            <mat-icon>person</mat-icon> {{ team.owner?.username }}
          </span>
        </div>
        <h1 class="team-name">{{ team.name }}</h1>
      </div>
    </div>

    <div class="hero-actions">
      <button mat-stroked-button color="primary" routerLink="../..">
        <mat-icon>arrow_back</mat-icon> {{ t.t('teams.detail.backToTeams') }}
      </button>
    </div>

    <div class="hero-decoration">
      <div class="glow-circle"></div>
    </div>
  </header>

  <!-- Key Stats Row -->
  <section class="stats-overview">
    <div class="stat-card total-points">
      <div class="stat-icon"><mat-icon>emoji_events</mat-icon></div>
      <div class="stat-content">
        <span class="stat-value">{{ formatPoints(team.totalPoints || 0) }}</span>
        <span class="stat-label">{{ t.t('teams.detail.pointsTotal') }}</span>
      </div>
    </div>

    <div class="stat-card avg-points">
      <div class="stat-icon"><mat-icon>bar_chart</mat-icon></div>
      <div class="stat-content">
        <span class="stat-value">{{ getTop10PercentPlayersCount() }}</span>
        <span class="stat-label">{{ t.t('teams.detail.topPlayersLabel') }}</span>
      </div>
    </div>

    <div class="stat-card players-count">
      <div class="stat-icon"><mat-icon>groups</mat-icon></div>
      <div class="stat-content">
        <span class="stat-value">{{ team.players.length }}</span>
        <span class="stat-label">{{ t.t('teams.detail.rosterCount') }}</span>
      </div>
    </div>
  </section>

  <!-- Main Content Grid -->
  <div class="detail-grid">

    <!-- Left Column: Roster -->
    <div class="roster-column">
      <div class="section-header">
        <h2><mat-icon>group</mat-icon> {{ t.t('teams.detail.rosterTitle') }}</h2>
      </div>

      <div class="roster-grid">
        <div class="player-card" *ngFor="let teamPlayer of getSortedPlayers(); let i = index"
          [class.top-performer]="i < 3">

          <div class="rank-indicator">#{{ i + 1 }}</div>

          <div class="player-content">
            <div class="player-header">
              <span class="player-name">{{ teamPlayer.player.nickname }}</span>
              <div class="player-tags">
                <span class="region-tag" [style.background]="getRegionColor(teamPlayer.player.region)">
                  {{ teamPlayer.player.region }}
                </span>
                <span class="tranche-tag">T{{ teamPlayer.player.tranche }}</span>
              </div>
            </div>

            <div class="player-stats">
              <div class="points-row">
                <span class="points">{{ formatPoints(teamPlayer.player.points || 0) }} {{ t.t('teams.common.pointsShort') }}</span>
                <mat-progress-bar mode="determinate" [value]="getProgressPercentage(teamPlayer.player.points || 0)"
                  class="points-bar">
                </mat-progress-bar>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Analytics (Charts) -->
    <div class="analytics-column" *ngIf="stats">
      <div class="section-header">
        <h2><mat-icon>pie_chart</mat-icon> {{ t.t('teams.detail.analyticsTitle') }}</h2>
      </div>

      <!-- Region Distribution Chart -->
      <div class="analytics-card">
        <h3>{{ t.t('teams.detail.regionDistribution') }}</h3>
        <div class="chart-container">
          <div class="pie-chart-wrapper">
            <svg viewBox="0 0 100 100" class="pie-svg">
              <circle *ngFor="let region of getSortedRegionsByRatio()" [attr.cx]="50" [attr.cy]="50" [attr.r]="15.915"
                [attr.fill]="'transparent'" [attr.stroke]="getRegionColor(region)" [attr.stroke-width]="20"
                [attr.stroke-dasharray]="getRegionArcLengthByRatio(region) + ' ' + (100 - getRegionArcLengthByRatio(region))"
                [attr.stroke-dashoffset]="getRegionArcOffsetByRatio(region)" class="pie-segment">
              </circle>
            </svg>
            <div class="pie-center">
              <span class="center-val">{{ stats.regionDistribution ? Object.keys(stats.regionDistribution).length : 0
                }}</span>
              <span class="center-lbl">{{ t.t('teams.detail.regionsLabel') }}</span>
            </div>
          </div>

          <div class="chart-legend">
            <div class="legend-item" *ngFor="let region of getSortedRegionsByRatio().slice(0, 5)">
              <span class="dot" [style.background]="getRegionColor(region)"></span>
              <span class="name">{{ region }}</span>
              <span class="val">{{ getRegionRatio(region) }}%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Top Performers Podium (Mini) -->
      <div class="analytics-card podium-card" *ngIf="getTopPlayers().length >= 1">
        <h3>{{ t.t('teams.detail.bestPlayer') }}</h3>
        <div class="mvp-showcase">
          <div class="mvp-crown"><mat-icon>emoji_events</mat-icon></div>
          <div class="mvp-avatar">{{ getTopPlayers()[0].player.nickname.charAt(0) }}</div>
          <div class="mvp-name">{{ getTopPlayers()[0].player.nickname }}</div>
          <div class="mvp-points">{{ formatPoints(getTopPlayers()[0].player.points || 0) }} {{ t.t('teams.common.pointsShort') }}</div>
        </div>
      </div>

    </div>
  </div>

</div>

<ng-template #loadingOrError>
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>{{ t.t('teams.detail.loadingTeamData') }}</p>
  </div>

  <div class="error-state" *ngIf="error">
    <mat-icon>error_outline</mat-icon>
    <h3>{{ t.t('teams.detail.errorTitle') }}</h3>
    <p>{{ error }}</p>
    <button mat-stroked-button (click)="retryLoad()">{{ t.t('common.retry') }}</button>
  </div>
</ng-template>
