<div class="game-detail-container">
  <!-- Loading Spinner -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner></mat-spinner>
    <p>{{ t.t('games.detail.loading') }}</p>
  </div>

  <!-- Error Message -->
  <div class="error-container" *ngIf="error && !loading">
    <mat-card class="error-card">
      <mat-card-content>
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error }}</p>
        <button mat-button color="primary" (click)="retryLoad()">
          {{ t.t('games.detail.retry') }}
        </button>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Game Details -->
  <div class="game-content" *ngIf="game && !loading">
    <!-- Header -->
    <div class="game-header">
      <div class="header-content">
        <div class="title-row">
          <h1>ðŸŽ® {{ game.name }}</h1>
          <button mat-icon-button
                  *ngIf="canRenameGame()"
                  (click)="renameGame()"
                  [matTooltip]="t.t('games.detail.renameTooltip')"
                  class="rename-btn">
            <mat-icon>edit</mat-icon>
          </button>
        </div>
        <p>{{ t.t('games.detail.createdBy') }} {{ game.creatorName }} â€¢ {{ getTimeAgo(game.createdAt) }}</p>
      </div>
      <button mat-button (click)="onBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
        {{ t.t('games.detail.back') }}
      </button>
    </div>

    <!-- Game Status and Actions -->
    <div class="game-status-section">
      <mat-card class="status-card">
        <mat-card-content>
          <div class="status-info">
            <div class="status-badge">
              <mat-chip [color]="getStatusColor(game.status)" selected>
                {{ getStatusLabel(game.status) }}
              </mat-chip>
            </div>
            <div class="game-stats">
              <div class="stat-item">
                <mat-icon>group</mat-icon>
                <span>{{ game.participantCount }}/{{ game.maxParticipants }} {{ t.t('games.detail.participants') }}</span>
              </div>
              <div class="stat-item">
                <mat-icon>schedule</mat-icon>
                <span>{{ getTimeAgo(game.createdAt) }}</span>
              </div>
            </div>
          </div>

          <!-- Participants Progress -->
          <div class="participants-progress-section">
            <div class="progress-header">
              <span>{{ t.t('games.detail.fillProgress') }}</span>
              <span>{{ getParticipantPercentage() }}%</span>
            </div>
            <mat-progress-bar
              [value]="getParticipantPercentage()"
              [color]="getParticipantColor()"
              class="participants-progress">
            </mat-progress-bar>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <!-- Join Game Button -->
            <button mat-raised-button
                    color="accent"
                    *ngIf="canJoinGame()"
                    (click)="joinGame()"
                    [matTooltip]="t.t('games.detail.joinTooltip')">
              <mat-icon>group_add</mat-icon>
              {{ t.t('games.detail.join') }}
            </button>

            <!-- Start Draft Button -->
            <button mat-raised-button
                    color="primary"
                    *ngIf="canStartDraft()"
                    (click)="confirmStartDraft()"
                    [matTooltip]="t.t('games.detail.startDraftTooltip')">
              <mat-icon>play_arrow</mat-icon>
              {{ t.t('games.detail.startDraft') }}
            </button>

            <!-- Delete Game Button (Host only, CREATING status only) -->
            <button mat-raised-button
                    color="warn"
                    *ngIf="canDeleteGame()"
                    (click)="confirmDelete()"
                    [matTooltip]="t.t('games.detail.deleteTooltip')">
              <mat-icon>delete_forever</mat-icon>
              {{ t.t('games.detail.delete') }}
            </button>

            <!-- Archive Game Button (Host only, for finished games) -->
            <button mat-raised-button
                    color="accent"
                    *ngIf="canArchiveGame() && !canDeleteGame()"
                    (click)="confirmArchive()"
                    [matTooltip]="t.t('games.detail.archiveTooltip')">
              <mat-icon>archive</mat-icon>
              {{ t.t('games.detail.archive') }}
            </button>

            <!-- Leave Game Button (Participant non-host) -->
            <button mat-raised-button
                    color="accent"
                    *ngIf="canLeaveGame()"
                    (click)="confirmLeave()"
                    [matTooltip]="t.t('games.detail.leaveTooltip')">
              <mat-icon>exit_to_app</mat-icon>
              {{ t.t('games.detail.leave') }}
            </button>

            <!-- Game Full Message -->
            <div class="game-full-message" *ngIf="!canJoinGame() && game.participantCount >= game.maxParticipants">
              <mat-icon color="warn">block</mat-icon>
              <span>{{ t.t('games.detail.gameFull') }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Participants Section -->
    <div class="participants-section">
      <mat-card class="participants-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>group</mat-icon>
            {{ t.t('games.detail.participantsTitle') }} ({{ participants.length }})
          </mat-card-title>
          <mat-card-subtitle>
            {{ t.t('games.detail.participantsSubtitle') }}
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="participants-error" *ngIf="participantsError">
            <mat-icon color="warn">error_outline</mat-icon>
            <p>{{ participantsError }}</p>
            <button mat-button color="primary" (click)="loadParticipants()">
              {{ t.t('games.detail.retry') }}
            </button>
          </div>

          <!-- Creator -->
          <div class="creator-section" *ngIf="getCreator()">
            <h3>ðŸ‘‘ {{ t.t('games.detail.creator') }}</h3>
            <mat-list>
              <mat-list-item class="creator-item">
                <mat-icon matListItemIcon [color]="getParticipantStatusColor(getCreator()!)">
                  {{ getParticipantStatusIcon(getCreator()!) }}
                </mat-icon>
                <div matListItemTitle>{{ getCreator()!.username }}</div>
                <div matListItemLine>{{ getTimeAgo(getCreator()!.joinedAt) }}</div>
                <mat-chip matListItemMeta [color]="getParticipantStatusColor(getCreator()!)" selected>
                  {{ getParticipantStatusLabel(getCreator()!) }}
                </mat-chip>
              </mat-list-item>
            </mat-list>
          </div>

          <!-- Other Participants -->
          <div class="other-participants-section" *ngIf="getNonCreatorParticipants().length > 0">
            <h3>ðŸ‘¥ {{ t.t('games.detail.participantsTitle') }}</h3>
            <mat-list>
              <mat-list-item *ngFor="let participant of getNonCreatorParticipants()" class="participant-item">
                <mat-icon matListItemIcon [color]="getParticipantStatusColor(participant)">
                  {{ getParticipantStatusIcon(participant) }}
                </mat-icon>
                <div matListItemTitle>{{ participant.username }}</div>
                <div matListItemLine>{{ getTimeAgo(participant.joinedAt) }}</div>
                <mat-chip matListItemMeta [color]="getParticipantStatusColor(participant)" selected>
                  {{ getParticipantStatusLabel(participant) }}
                </mat-chip>
              </mat-list-item>
            </mat-list>
          </div>

          <!-- Empty State -->
          <div class="empty-participants" *ngIf="participants.length === 0 && !participantsError">
            <mat-icon class="empty-icon">group_off</mat-icon>
            <h3>{{ t.t('games.detail.noParticipants') }}</h3>
            <p>{{ t.t('games.detail.beFirst') }}</p>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Game Information -->
    <div class="game-info-section">
      <mat-card class="info-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info</mat-icon>
            {{ t.t('games.detail.gameInfo') }}
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <div class="info-grid">
            <div class="info-item">
              <mat-icon>title</mat-icon>
              <div class="info-content">
                <span class="info-label">{{ t.t('games.detail.name') }}</span>
                <span class="info-value">{{ game.name }}</span>
              </div>
            </div>

            <div class="info-item">
              <mat-icon>person</mat-icon>
              <div class="info-content">
                <span class="info-label">{{ t.t('games.detail.creatorLabel') }}</span>
                <span class="info-value">{{ game.creatorName }}</span>
              </div>
            </div>

            <div class="info-item">
              <mat-icon>group</mat-icon>
              <div class="info-content">
                <span class="info-label">{{ t.t('games.detail.participantsTitle') }}</span>
                <span class="info-value">{{ game.participantCount }}/{{ game.maxParticipants }}</span>
              </div>
            </div>

            <div class="info-item">
              <mat-icon>schedule</mat-icon>
              <div class="info-content">
                <span class="info-label">{{ t.t('games.detail.createdOn') }}</span>
                <span class="info-value">{{ getTimeAgo(game.createdAt) }}</span>
              </div>
            </div>

            <div class="info-item">
              <mat-icon>flag</mat-icon>
              <div class="info-content">
                <span class="info-label">{{ t.t('games.detail.status') }}</span>
                <span class="info-value">{{ getStatusLabel(game.status) }}</span>
              </div>
            </div>

            <!-- Invitation Code -->
            <div class="info-item invitation-code-item" *ngIf="game.invitationCode">
              <mat-icon>vpn_key</mat-icon>
              <div class="info-content">
                <span class="info-label">{{ t.t('games.detail.invitationCode') }}</span>
                <div class="invitation-code-wrapper">
                  <span class="info-value code-value"
                        [class.expired]="game.isInvitationCodeExpired">
                    {{ game.invitationCode }}
                  </span>
                  <mat-chip *ngIf="game.isInvitationCodeExpired" color="warn" selected class="expired-chip">
                    {{ t.t('games.detail.expired') }}
                  </mat-chip>
                  <mat-chip *ngIf="!game.isInvitationCodeExpired && game.invitationCodeExpiresAt"
                            color="accent" selected class="expiry-chip">
                    {{ t.t('games.detail.expiresOn') }} {{ getInvitationCodeExpiry() }}
                  </mat-chip>
                  <button mat-icon-button
                          (click)="copyInvitationCode()"
                          [disabled]="game.isInvitationCodeExpired"
                          [matTooltip]="t.t('games.detail.copyCode')"
                          class="copy-btn">
                    <mat-icon>content_copy</mat-icon>
                  </button>
                  <button mat-icon-button
                          *ngIf="canRegenerateCode()"
                          (click)="promptRegenerateCode()"
                          [matTooltip]="t.t('games.detail.regenerateCode')"
                          class="regenerate-btn">
                    <mat-icon>refresh</mat-icon>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Draft Information (if applicable) -->
    <div class="draft-section" *ngIf="game.status === 'DRAFTING'">
      <mat-card class="draft-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>shuffle</mat-icon>
            {{ t.t('games.detail.draftPhase') }}
          </mat-card-title>
          <mat-card-subtitle>
            {{ t.t('games.detail.draftSubtitle') }}
          </mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <p>{{ t.t('games.detail.draftInProgress') }}</p>
          <button mat-raised-button color="primary" routerLink="/draft/{{ game.id }}">
            <mat-icon>visibility</mat-icon>
            {{ t.t('games.detail.viewDraft') }}
          </button>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
