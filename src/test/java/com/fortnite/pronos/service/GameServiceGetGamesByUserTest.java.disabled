package com.fortnite.pronos.service;

import com.fortnite.pronos.dto.GameDto;
import com.fortnite.pronos.model.Game;
import com.fortnite.pronos.model.GameParticipant;
import com.fortnite.pronos.model.GameStatus;
import com.fortnite.pronos.model.User;
import com.fortnite.pronos.repository.GameParticipantRepository;
import com.fortnite.pronos.repository.GameRepository;
import com.fortnite.pronos.repository.UserRepository;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
class GameServiceGetGamesByUserTest {

    @Mock
    private UserRepository userRepository;

    @Mock
    private GameRepository gameRepository;

    @Mock
    private GameParticipantRepository gameParticipantRepository;

    @InjectMocks
    private RefactoredGameService refactoredGameService;

    private User thibaut;
    private User marcel;
    private User teddy;
    private Game gameCreatedByThibaut;
    private Game gameCreatedByMarcel;
    private GameParticipant thibautParticipant1;
    private GameParticipant marcelParticipant1;
    private GameParticipant teddyParticipant1;
    private GameParticipant thibautParticipant2;

    @BeforeEach
    void setUp() {
        // Utilisateurs
        thibaut = new User();
        thibaut.setId(UUID.randomUUID());
        thibaut.setUsername("Thibaut");

        marcel = new User();
        marcel.setId(UUID.randomUUID());
        marcel.setUsername("Marcel");

        teddy = new User();
        teddy.setId(UUID.randomUUID());
        teddy.setUsername("Teddy");

        // Game créée par Thibaut
        gameCreatedByThibaut = new Game();
        gameCreatedByThibaut.setId(UUID.randomUUID());
        gameCreatedByThibaut.setName("Game de Test - Thibaut vs Marcel vs Teddy");
        gameCreatedByThibaut.setCreator(thibaut);
        gameCreatedByThibaut.setStatus(GameStatus.ACTIVE);
        gameCreatedByThibaut.setMaxParticipants(10);
        gameCreatedByThibaut.setCreatedAt(LocalDateTime.now());

        // Game créée par Marcel (où Thibaut participe)
        gameCreatedByMarcel = new Game();
        gameCreatedByMarcel.setId(UUID.randomUUID());
        gameCreatedByMarcel.setName("Game de Marcel");
        gameCreatedByMarcel.setCreator(marcel);
        gameCreatedByMarcel.setStatus(GameStatus.DRAFTING);
        gameCreatedByMarcel.setMaxParticipants(8);
        gameCreatedByMarcel.setCreatedAt(LocalDateTime.now());

        // Participants
        thibautParticipant1 = new GameParticipant();
        thibautParticipant1.setId(UUID.randomUUID());
        thibautParticipant1.setGame(gameCreatedByThibaut);
        thibautParticipant1.setUser(thibaut);
        thibautParticipant1.setDraftOrder(1);

        marcelParticipant1 = new GameParticipant();
        marcelParticipant1.setId(UUID.randomUUID());
        marcelParticipant1.setGame(gameCreatedByThibaut);
        marcelParticipant1.setUser(marcel);
        marcelParticipant1.setDraftOrder(2);

        teddyParticipant1 = new GameParticipant();
        teddyParticipant1.setId(UUID.randomUUID());
        teddyParticipant1.setGame(gameCreatedByThibaut);
        teddyParticipant1.setUser(teddy);
        teddyParticipant1.setDraftOrder(3);

        thibautParticipant2 = new GameParticipant();
        thibautParticipant2.setId(UUID.randomUUID());
        thibautParticipant2.setGame(gameCreatedByMarcel);
        thibautParticipant2.setUser(thibaut);
        thibautParticipant2.setDraftOrder(2);
    }

    @Test
    @DisplayName("devrait récupérer toutes les games d'un utilisateur (créées + participant)")
    void shouldReturnAllUserGames() {
        // Given
        when(userRepository.findById(thibaut.getId())).thenReturn(Optional.of(thibaut));
        when(gameRepository.findByCreator(thibaut)).thenReturn(Arrays.asList(gameCreatedByThibaut));
        when(gameParticipantRepository.findByUser(thibaut)).thenReturn(Arrays.asList(thibautParticipant1, thibautParticipant2));

        // When
        List<GameDto> games = refactoredGameService.getGamesByUser(thibaut.getId());

        // Then
        assertThat(games).hasSize(2);
        assertThat(games)
            .extracting(GameDto::getName)
            .containsExactlyInAnyOrder(
                "Game de Test - Thibaut vs Marcel vs Teddy",
                "Game de Marcel"
            );
    }

    @Test
    @DisplayName("devrait retourner les games créées et celles où l'utilisateur participe")
    void shouldReturnCreatedAndParticipatingGames() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findByCreator(marcel)).thenReturn(Arrays.asList(gameCreatedByMarcel));
        when(gameParticipantRepository.findByUser(marcel)).thenReturn(Arrays.asList(marcelParticipant1)); // Marcel participe à la game de Thibaut

        // When
        List<GameDto> games = refactoredGameService.getGamesByUser(marcel.getId());

        // Then
        assertThat(games).hasSize(2); // Game créée par Marcel + Game où Marcel participe
        assertThat(games)
            .extracting(GameDto::getName)
            .containsExactlyInAnyOrder(
                "Game de Marcel",
                "Game de Test - Thibaut vs Marcel vs Teddy"
            );
    }

    @Test
    @DisplayName("devrait retourner une liste vide si aucune game")
    void shouldReturnEmptyListIfNoGames() {
        // Given
        User sarah = new User();
        sarah.setId(UUID.randomUUID());
        sarah.setUsername("Sarah");

        when(userRepository.findById(sarah.getId())).thenReturn(Optional.of(sarah));
        when(gameRepository.findByCreator(sarah)).thenReturn(Arrays.asList());
        when(gameParticipantRepository.findByUser(sarah)).thenReturn(Arrays.asList());

        // When
        List<GameDto> games = refactoredGameService.getGamesByUser(sarah.getId());

        // Then
        assertThat(games).isEmpty();
    }

    @Test
    @DisplayName("devrait lever une exception si l'utilisateur n'existe pas")
    void shouldThrowExceptionIfUserNotFound() {
        // Given
        UUID unknownUserId = UUID.randomUUID();
        when(userRepository.findById(unknownUserId)).thenReturn(Optional.empty());

        // When/Then
        assertThatThrownBy(() -> refactoredGameService.getGamesByUser(unknownUserId))
            .isInstanceOf(IllegalArgumentException.class)
            .hasMessageContaining("Utilisateur non trouvé");
    }

    @Test
    @DisplayName("ne devrait pas retourner de doublons si créateur ET participant")
    void shouldNotReturnDuplicatesIfCreatorAndParticipant() {
        // Given
        when(userRepository.findById(thibaut.getId())).thenReturn(Optional.of(thibaut));
        when(gameRepository.findByCreator(thibaut)).thenReturn(Arrays.asList(gameCreatedByThibaut));
        when(gameParticipantRepository.findByUser(thibaut)).thenReturn(Arrays.asList(thibautParticipant1)); // Participant à sa propre game

        // When
        List<GameDto> games = refactoredGameService.getGamesByUser(thibaut.getId());

        // Then
        assertThat(games).hasSize(1); // Pas de doublon
        assertThat(games.get(0).getName()).isEqualTo("Game de Test - Thibaut vs Marcel vs Teddy");
    }
} 