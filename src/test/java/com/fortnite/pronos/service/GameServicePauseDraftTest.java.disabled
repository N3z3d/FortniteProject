package com.fortnite.pronos.service;

import com.fortnite.pronos.dto.DraftDto;
import com.fortnite.pronos.exception.*;
import com.fortnite.pronos.model.*;
import com.fortnite.pronos.repository.*;
import com.fortnite.pronos.service.draft.DraftService;
import com.fortnite.pronos.util.TestDataBuilder;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;

import java.time.LocalDateTime;
import java.util.*;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * Tests TDD pour GameService.pauseDraft() et resumeDraft()
 * Clean Code : une classe de test par fonctionnalité majeure
 */
@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
@DisplayName("Tests TDD - GameService.pauseDraft() & resumeDraft()")
class GameServicePauseDraftTest {

    @Mock
    private GameRepository gameRepository;
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private DraftRepository draftRepository;
    
    @Mock
    private DraftPickRepository draftPickRepository;
    
    @Mock
    private GameParticipantRepository gameParticipantRepository;
    
    @Mock
    private DraftService draftService;
    
    @InjectMocks
    private RefactoredGameService refactoredGameService;
    
    private User marcel;
    private User teddy;
    private Game testGame;
    private Draft testDraft;
    private List<GameParticipant> participants;
    
    @BeforeEach
    void setUp() {
        // Créer les utilisateurs
        marcel = TestDataBuilder.createMarcel();
        marcel.setId(UUID.randomUUID());
        
        teddy = TestDataBuilder.createTeddy();
        teddy.setId(UUID.randomUUID());
        
        // Créer une game en draft
        testGame = TestDataBuilder.createValidGame(marcel, "Draft Fortnite");
        testGame.setId(UUID.randomUUID());
        testGame.setStatus(GameStatus.DRAFTING);
        
        // Créer le draft actif
        testDraft = new Draft(testGame);
        testDraft.setId(UUID.randomUUID());
        testDraft.setStatus(Draft.Status.ACTIVE);
        testDraft.setCurrentRound(2);
        testDraft.setCurrentPick(3);
        testDraft.setTotalRounds(10);
        
        // Créer les participants
        participants = Arrays.asList(
            createParticipant(marcel, 1),
            createParticipant(teddy, 2)
        );
    }
    
    private GameParticipant createParticipant(User user, int draftOrder) {
        GameParticipant participant = TestDataBuilder.createValidParticipant(testGame, user, draftOrder);
        participant.setId(UUID.randomUUID());
        return participant;
    }
    
    // ========== TESTS PAUSE DRAFT ==========
    
    // UC10.1 : Pause basique du draft
    @Test
    @DisplayName("UC10.1 - Marcel devrait pouvoir mettre en pause le draft")
    void shouldAllowMarcelToPauseDraft() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        when(draftRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        
        // When
        refactoredGameService.pauseDraft(testGame.getId(), marcel.getId());
        
        // Then
        // Vérifier que la méthode s'exécute sans exception
        
        verify(draftRepository).save(argThat(draft -> 
            draft.getStatus() == Draft.Status.PAUSED
        ));
    }
    
    // UC10.2 : Seul le créateur peut pauser
    @Test
    @DisplayName("UC10.2 - Teddy ne devrait pas pouvoir pauser le draft créé par Marcel")
    void shouldRejectPauseIfNotCreator() {
        // Given
        when(userRepository.findById(teddy.getId())).thenReturn(Optional.of(teddy));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.pauseDraft(testGame.getId(), teddy.getId()))
            .isInstanceOf(UnauthorizedAccessException.class)
            .hasMessageContaining("Seul le créateur");
    }
    
    // UC10.3 : Ne peut pas pauser un draft déjà en pause
    @Test
    @DisplayName("UC10.3 - Ne devrait pas pouvoir pauser un draft déjà en pause")
    void shouldRejectPauseIfAlreadyPaused() {
        // Given
        testDraft.setStatus(Draft.Status.PAUSED);
        
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.pauseDraft(testGame.getId(), marcel.getId()))
            .isInstanceOf(InvalidDraftStateException.class)
            .hasMessageContaining("déjà en pause");
    }
    
    // UC10.4 : Ne peut pas pauser un draft terminé
    @Test
    @DisplayName("UC10.4 - Ne devrait pas pouvoir pauser un draft terminé")
    void shouldRejectPauseIfDraftFinished() {
        // Given
        testDraft.setStatus(Draft.Status.FINISHED);
        
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.pauseDraft(testGame.getId(), marcel.getId()))
            .isInstanceOf(InvalidDraftStateException.class)
            .hasMessageContaining("terminé");
    }
    
    // ========== TESTS RESUME DRAFT ==========
    
    // UC11.1 : Reprendre un draft en pause
    @Test
    @DisplayName("UC11.1 - Marcel devrait pouvoir reprendre le draft en pause")
    void shouldAllowMarcelToResumeDraft() {
        // Given
        testDraft.setStatus(Draft.Status.PAUSED);
        
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        when(draftRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        
        // When
        refactoredGameService.resumeDraft(testGame.getId(), marcel.getId());
        
        // Then
        // Vérifier que la méthode s'exécute sans exception
        
        verify(draftRepository).save(argThat(draft -> 
            draft.getStatus() == Draft.Status.ACTIVE
        ));
    }
    
    // UC11.2 : Seul le créateur peut reprendre
    @Test
    @DisplayName("UC11.2 - Teddy ne devrait pas pouvoir reprendre le draft créé par Marcel")
    void shouldRejectResumeIfNotCreator() {
        // Given
        testDraft.setStatus(Draft.Status.PAUSED);
        
        when(userRepository.findById(teddy.getId())).thenReturn(Optional.of(teddy));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.resumeDraft(testGame.getId(), teddy.getId()))
            .isInstanceOf(UnauthorizedAccessException.class)
            .hasMessageContaining("Seul le créateur");
    }
    
    // UC11.3 : Ne peut pas reprendre un draft actif
    @Test
    @DisplayName("UC11.3 - Ne devrait pas pouvoir reprendre un draft déjà actif")
    void shouldRejectResumeIfNotPaused() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.resumeDraft(testGame.getId(), marcel.getId()))
            .isInstanceOf(InvalidDraftStateException.class)
            .hasMessageContaining("pas en pause");
    }
    

    
    // Test d'intégration : Workflow pause/resume
    @Test
    @DisplayName("Workflow complet - Pause puis reprise du draft")
    void shouldCompletePauseResumeWorkflow() {
        // Given - État initial actif
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        when(draftRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        
        // When - Pause
        refactoredGameService.pauseDraft(testGame.getId(), marcel.getId());
        
        // Then - Vérifier pause
        // Vérifier que la méthode s'exécute sans exception
        
        // Given - Préparer pour resume
        testDraft.setStatus(Draft.Status.PAUSED);
        
        // When - Resume
        refactoredGameService.resumeDraft(testGame.getId(), marcel.getId());
        
        // Then - Vérifier resume
        // Vérifier que la méthode s'exécute sans exception
    }
    
    // Performance
    @Test
    @DisplayName("Performance - Devrait pauser/reprendre en moins de 100ms chacun")
    void shouldPauseResumeQuickly() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(draftRepository.findByGame(testGame)).thenReturn(Optional.of(testDraft));
        when(draftRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        
        // When - Pause
        long startPause = System.currentTimeMillis();
        refactoredGameService.pauseDraft(testGame.getId(), marcel.getId());
        long endPause = System.currentTimeMillis();
        
        // Then
        assertThat(endPause - startPause).isLessThan(100);
        
        // Given - Préparer pour resume
        testDraft.setStatus(Draft.Status.PAUSED);
        
        // When - Resume
        long startResume = System.currentTimeMillis();
        refactoredGameService.resumeDraft(testGame.getId(), marcel.getId());
        long endResume = System.currentTimeMillis();
        
        // Then
        assertThat(endResume - startResume).isLessThan(100);
    }
} 