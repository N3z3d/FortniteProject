package com.fortnite.pronos.service;

import com.fortnite.pronos.dto.DraftDto;
import com.fortnite.pronos.exception.GameNotFoundException;
import com.fortnite.pronos.exception.InsufficientParticipantsException;
import com.fortnite.pronos.exception.InvalidGameStateException;
import com.fortnite.pronos.exception.UnauthorizedAccessException;
import com.fortnite.pronos.model.*;
import com.fortnite.pronos.repository.DraftRepository;
import com.fortnite.pronos.repository.GameParticipantRepository;
import com.fortnite.pronos.repository.GameRepository;
import com.fortnite.pronos.repository.UserRepository;
import com.fortnite.pronos.service.draft.DraftService;
import com.fortnite.pronos.util.TestDataBuilder;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;

import java.time.LocalDateTime;
import java.util.*;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * Tests TDD pour GameService.startDraft()
 * Clean Code : une classe de test par fonctionnalité majeure
 */
@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
@DisplayName("Tests TDD - GameService.startDraft()")
class GameServiceStartDraftTest {

    @Mock
    private GameRepository gameRepository;
    
    @Mock
    private UserRepository userRepository;
    
    @Mock
    private GameParticipantRepository gameParticipantRepository;
    
    @Mock
    private DraftRepository draftRepository;
    
    @Mock
    private DraftService draftService;
    
    @Mock
    private ValidationService validationService;
    
    @InjectMocks
    private RefactoredGameService refactoredGameService;
    
    private User marcel;
    private User teddy;
    private User thibaut;
    private User sarah;
    private Game testGame;
    private List<GameParticipant> participants;
    
    @BeforeEach
    void setUp() {
        // Créer les utilisateurs
        marcel = TestDataBuilder.createMarcel();
        marcel.setId(UUID.randomUUID());
        
        teddy = TestDataBuilder.createTeddy();
        teddy.setId(UUID.randomUUID());
        
        thibaut = TestDataBuilder.createThibaut();
        thibaut.setId(UUID.randomUUID());
        
        sarah = TestDataBuilder.createSarah();
        sarah.setId(UUID.randomUUID());
        
        // Créer une game prête pour le draft
        testGame = TestDataBuilder.createValidGame(marcel, "Draft Fortnite");
        testGame.setId(UUID.randomUUID());
        testGame.setStatus(GameStatus.CREATING);
        testGame.setMaxParticipants(4);
        
        // Créer les participants
        participants = new ArrayList<>();
        participants.add(TestDataBuilder.createValidParticipant(testGame, marcel, 1));
        participants.add(TestDataBuilder.createValidParticipant(testGame, teddy, 2));
        participants.add(TestDataBuilder.createValidParticipant(testGame, thibaut, 3));
        participants.add(TestDataBuilder.createValidParticipant(testGame, sarah, 4));
    }
    
    // UC7.1 : Démarrer le draft normal
    @Test
    @DisplayName("UC7.1 - Marcel devrait pouvoir démarrer le draft de sa game")
    void shouldAllowMarcelToStartDraft() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(gameParticipantRepository.findByGame(testGame)).thenReturn(participants);
        when(gameParticipantRepository.countByGame(testGame)).thenReturn(4L); // 4 participants
        when(draftService.createDraft(any(Game.class), anyList())).thenAnswer(invocation -> {
            Draft draft = new Draft(invocation.getArgument(0));
            draft.setId(UUID.randomUUID());
            draft.setStatus(Draft.Status.ACTIVE);
            draft.setCurrentRound(1);
            draft.setCurrentPick(1);
            draft.setTotalRounds(10); // Valeur par défaut sans règles régionales
            return draft;
        });
        when(gameRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        
        // When
        DraftDto result = refactoredGameService.startDraft(marcel.getId(), testGame.getId());
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getStatus()).isEqualTo(Draft.Status.ACTIVE);
        assertThat(result.getTotalRounds()).isGreaterThan(0);
        
        // Vérifier que le statut de la game a changé
        verify(gameRepository).save(argThat(game -> 
            game.getStatus() == GameStatus.DRAFTING
        ));
    }
    
    // Validation : Seul le créateur peut démarrer
    @Test
    @DisplayName("Devrait rejeter si ce n'est pas le créateur qui démarre")
    void shouldRejectIfNotCreator() {
        // Given
        when(userRepository.findById(teddy.getId())).thenReturn(Optional.of(teddy));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.startDraft(teddy.getId(), testGame.getId()))
            .isInstanceOf(UnauthorizedAccessException.class)
            .hasMessageContaining("Seul le créateur");
    }
    
    // Validation : Nombre minimum de participants
    @Test
    @DisplayName("Devrait rejeter s'il n'y a pas assez de participants")
    void shouldRejectIfNotEnoughParticipants() {
        // Given
        List<GameParticipant> fewParticipants = Arrays.asList(participants.get(0)); // Seulement Marcel
        
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(gameParticipantRepository.findByGame(testGame)).thenReturn(fewParticipants);
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.startDraft(marcel.getId(), testGame.getId()))
            .isInstanceOf(InsufficientParticipantsException.class)
            .hasMessageContaining("au moins 2 participants");
    }
    
    // Validation : État de la game
    @Test
    @DisplayName("Devrait rejeter si la game n'est pas en état CREATING")
    void shouldRejectIfGameNotInCreatingState() {
        // Given
        testGame.setStatus(GameStatus.ACTIVE);
        
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.startDraft(marcel.getId(), testGame.getId()))
            .isInstanceOf(InvalidGameStateException.class)
            .hasMessageContaining("Le draft ne peut être démarré");
    }
    
    // UC7.2 : Draft avec ordre aléatoire
    @Test
    @DisplayName("UC7.2 - Devrait randomiser l'ordre des participants")
    void shouldRandomizeDraftOrder() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(gameParticipantRepository.findByGame(testGame)).thenReturn(participants);
        when(gameParticipantRepository.countByGame(testGame)).thenReturn(4L); // 4 participants
        when(draftService.createDraft(any(Game.class), anyList())).thenAnswer(invocation -> {
            List<GameParticipant> shuffled = invocation.getArgument(1);
            // Vérifier que la liste a été mélangée
            assertThat(shuffled).hasSize(4);
            
            Draft draft = new Draft(invocation.getArgument(0));
            draft.setId(UUID.randomUUID());
            draft.setStatus(Draft.Status.ACTIVE);
            draft.setCurrentRound(1);
            draft.setCurrentPick(1);
            draft.setTotalRounds(10);
            return draft;
        });
        when(gameRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        when(gameParticipantRepository.saveAll(anyList())).thenAnswer(i -> i.getArgument(0));
        
        // When
        DraftDto result = refactoredGameService.startDraft(marcel.getId(), testGame.getId());
        
        // Then
        assertThat(result).isNotNull();
        
        // Vérifier que les ordres de draft ont été mis à jour
        verify(gameParticipantRepository).saveAll(anyList());
    }
    
    // UC7.3 : Draft avec règles régionales
    @Test
    @DisplayName("UC7.3 - Devrait respecter les règles régionales pour le nombre de tours")
    void shouldRespectRegionRulesForRounds() {
        // Given
        // Ajouter des règles régionales à la game
        GameRegionRule euRule = GameRegionRule.builder()
            .id(UUID.randomUUID())
            .game(testGame)
            .region(Player.Region.EU)
            .maxPlayers(5)
            .build();
        GameRegionRule nawRule = GameRegionRule.builder()
            .id(UUID.randomUUID())
            .game(testGame)
            .region(Player.Region.NAW)
            .maxPlayers(3)
            .build();
        testGame.getRegionRules().add(euRule);
        testGame.getRegionRules().add(nawRule);
        
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(gameParticipantRepository.findByGame(testGame)).thenReturn(participants);
        when(gameParticipantRepository.countByGame(testGame)).thenReturn(4L); // 4 participants
        when(draftService.createDraft(any(Game.class), anyList())).thenAnswer(invocation -> {
            Draft draft = new Draft(invocation.getArgument(0));
            draft.setId(UUID.randomUUID());
            draft.setTotalRounds(8); // 5 EU + 3 NAW
            return draft;
        });
        when(gameRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        
        // When
        DraftDto result = refactoredGameService.startDraft(marcel.getId(), testGame.getId());
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getTotalRounds()).isEqualTo(8);
    }
    
    // Cas d'erreur : Game non trouvée
    @Test
    @DisplayName("Devrait échouer si la game n'existe pas")
    void shouldFailIfGameNotFound() {
        // Given
        UUID unknownGameId = UUID.randomUUID();
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(unknownGameId)).thenReturn(Optional.empty());
        
        // When/Then
        assertThatThrownBy(() -> refactoredGameService.startDraft(marcel.getId(), unknownGameId))
            .isInstanceOf(GameNotFoundException.class)
            .hasMessageContaining("Game non trouvée");
    }
    
    // Test d'intégration : Workflow complet
    @Test
    @DisplayName("Workflow complet - Draft démarré avec tous les éléments")
    void shouldStartDraftWithCompleteWorkflow() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(gameParticipantRepository.findByGame(testGame)).thenReturn(participants);
        when(gameParticipantRepository.countByGame(testGame)).thenReturn(4L); // 4 participants
        
        Draft createdDraft = new Draft(testGame);
        createdDraft.setId(UUID.randomUUID());
        createdDraft.setStatus(Draft.Status.ACTIVE);
        createdDraft.setTotalRounds(10);
        createdDraft.setCurrentRound(1);
        createdDraft.setCurrentPick(1);
        
        when(draftService.createDraft(any(Game.class), anyList())).thenReturn(createdDraft);
        when(gameRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        when(gameParticipantRepository.saveAll(anyList())).thenAnswer(i -> i.getArgument(0));
        
        // When
        DraftDto result = refactoredGameService.startDraft(marcel.getId(), testGame.getId());
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getGameId()).isEqualTo(testGame.getId());
        assertThat(result.getStatus()).isEqualTo(Draft.Status.ACTIVE);
        assertThat(result.getCurrentRound()).isEqualTo(1);
        assertThat(result.getCurrentPick()).isEqualTo(1);
        assertThat(result.getTotalRounds()).isEqualTo(10);
        
        // Vérifications
        verify(gameRepository).save(argThat(game -> game.getStatus() == GameStatus.DRAFTING));
        verify(draftService).createDraft(eq(testGame), anyList());
        verify(gameParticipantRepository).saveAll(anyList());
    }
    
    // Performance
    @Test
    @DisplayName("Performance - Devrait démarrer le draft en moins de 200ms")
    void shouldStartDraftQuickly() {
        // Given
        when(userRepository.findById(marcel.getId())).thenReturn(Optional.of(marcel));
        when(gameRepository.findById(testGame.getId())).thenReturn(Optional.of(testGame));
        when(gameParticipantRepository.findByGame(testGame)).thenReturn(participants);
        when(gameParticipantRepository.countByGame(testGame)).thenReturn(4L); // 4 participants
        when(draftService.createDraft(any(Game.class), anyList())).thenAnswer(invocation -> {
            Draft draft = new Draft(invocation.getArgument(0));
            draft.setId(UUID.randomUUID());
            draft.setStatus(Draft.Status.ACTIVE);
            draft.setCurrentRound(1);
            draft.setCurrentPick(1);
            draft.setTotalRounds(10);
            return draft;
        });
        when(gameRepository.save(any())).thenAnswer(i -> i.getArgument(0));
        
        // When
        long startTime = System.currentTimeMillis();
        DraftDto result = refactoredGameService.startDraft(marcel.getId(), testGame.getId());
        long endTime = System.currentTimeMillis();
        
        // Then
        assertThat(result).isNotNull();
        assertThat(endTime - startTime).isLessThan(200);
    }
} 