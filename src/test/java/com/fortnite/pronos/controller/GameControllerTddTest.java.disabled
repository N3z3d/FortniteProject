package com.fortnite.pronos.controller;

import com.fortnite.pronos.dto.CreateGameRequest;
import com.fortnite.pronos.dto.GameDto;
import com.fortnite.pronos.exception.UserNotFoundException;
import com.fortnite.pronos.model.GameStatus;
import com.fortnite.pronos.model.Player;
import com.fortnite.pronos.model.User;
import com.fortnite.pronos.service.RefactoredGameService;
import com.fortnite.pronos.service.UserContextService;
import com.fortnite.pronos.service.ValidationService;
import com.fortnite.pronos.util.TestDataBuilder;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.test.web.servlet.MockMvc;
import org.springframework.test.web.servlet.setup.MockMvcBuilders;

import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.eq;
import static org.mockito.Mockito.when;
import static org.mockito.Mockito.doThrow;
import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.*;

/**
 * Tests TDD pour GameController
 * Focus sur la résolution du problème de création de games avec authentification par paramètre
 */
@ExtendWith(MockitoExtension.class)
class GameControllerTddTest {

    @Mock
    private RefactoredGameService refactoredGameService;

    @Mock
    private ValidationService validationService;

    @Mock
    private UserContextService userContextService;

    @InjectMocks
    private GameController gameController;

    private MockMvc mockMvc;
    private ObjectMapper objectMapper;

    private CreateGameRequest validGameRequest;
    private GameDto createdGameDto;
    private UUID testUserId;

    @BeforeEach
    void setUp() {
        mockMvc = MockMvcBuilders.standaloneSetup(gameController).build();
        objectMapper = new ObjectMapper();

        testUserId = UUID.randomUUID();
        
        validGameRequest = new CreateGameRequest(
            "Ma Première Game - TDD",
            10,
            "Game de test créée via TDD",
            false,
            false,
            300,
            43200,
            2025
        );

        createdGameDto = GameDto.builder()
            .id(UUID.randomUUID())
            .name("Ma Première Game - TDD")
            .creatorUsername("Thibaut")
            .maxParticipants(10)
            .status(GameStatus.CREATING)
            .currentParticipantCount(1)
            .build();
    }

    @Test
    @DisplayName("Devrait créer une game avec succès quand l'utilisateur est authentifié via paramètre")
    void shouldCreateGameSuccessfullyWhenUserAuthenticatedViaParam() throws Exception {
        // Given
        // validateCreateGameRequest ne retourne rien (void) - il lance une exception si invalide
        User mockUser = TestDataBuilder.createThibaut();
        mockUser.setId(testUserId);
        when(userContextService.findUserByUsername("Thibaut"))
            .thenReturn(mockUser);
        when(refactoredGameService.createGame(eq(testUserId), any(CreateGameRequest.class)))
            .thenReturn(createdGameDto);

        // When & Then
        mockMvc.perform(post("/api/games")
                .param("user", "Thibaut")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(validGameRequest)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.id").exists())
            .andExpect(jsonPath("$.name").value("Ma Première Game - TDD"))
            .andExpect(jsonPath("$.creatorUsername").value("Thibaut"))
            .andExpect(jsonPath("$.status").value("CREATING"));
    }

    @Test
    @DisplayName("Devrait retourner 401 quand l'utilisateur n'est pas trouvé en base")
    void shouldReturn401WhenUserNotFoundInDatabase() throws Exception {
        // Given
        // validateCreateGameRequest ne retourne rien (void) - il lance une exception si invalide
        when(userContextService.findUserByUsername("UtilisateurInexistant"))
            .thenThrow(new UserNotFoundException("Utilisateur non trouvé: UtilisateurInexistant"));

        // When & Then
        mockMvc.perform(post("/api/games")
                .param("user", "UtilisateurInexistant")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(validGameRequest)))
            .andExpect(status().isUnauthorized());
    }

    @Test
    @DisplayName("Devrait retourner 400 quand la requête de création est invalide")
    void shouldReturn400WhenCreateGameRequestIsInvalid() throws Exception {
        // Given
        doThrow(new IllegalArgumentException("Requête invalide"))
            .when(validationService).validateCreateGameRequest(any(CreateGameRequest.class));

        // When & Then
        mockMvc.perform(post("/api/games")
                .param("user", "Thibaut")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(validGameRequest)))
            .andExpect(status().isBadRequest());
    }

    @Test
    @DisplayName("Devrait créer une game sans paramètre user (utilise le fallback par défaut)")
    void shouldCreateGameWithoutUserParamUsingDefaultFallback() throws Exception {
        // Given
        // validateCreateGameRequest ne retourne rien (void) - il lance une exception si invalide
        User mockUser = TestDataBuilder.createThibaut();
        mockUser.setId(testUserId);
        when(userContextService.getCurrentUserWithFallback(null))
            .thenReturn(mockUser);
        when(refactoredGameService.createGame(eq(testUserId), any(CreateGameRequest.class)))
            .thenReturn(createdGameDto);

        // When & Then
        mockMvc.perform(post("/api/games")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(validGameRequest)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.name").value("Ma Première Game - TDD"));
    }

    @Test
    @DisplayName("Devrait retourner 500 quand une erreur interne survient")
    void shouldReturn500WhenInternalErrorOccurs() throws Exception {
        // Given
        // validateCreateGameRequest ne retourne rien (void) - il lance une exception si invalide
        User mockUser = TestDataBuilder.createThibaut();
        mockUser.setId(testUserId);
        when(userContextService.findUserByUsername("Thibaut"))
            .thenReturn(mockUser);
        when(refactoredGameService.createGame(eq(testUserId), any(CreateGameRequest.class)))
            .thenThrow(new RuntimeException("Erreur interne"));

        // When & Then
        mockMvc.perform(post("/api/games")
                .param("user", "Thibaut")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(validGameRequest)))
            .andExpect(status().isInternalServerError());
    }

    @Test
    @DisplayName("Devrait accepter un paramètre user avec des espaces")
    void shouldAcceptUserParamWithSpaces() throws Exception {
        // Given
        // validateCreateGameRequest ne retourne rien (void) - il lance une exception si invalide
        User mockUser = TestDataBuilder.createThibaut();
        mockUser.setId(testUserId);
        when(userContextService.findUserByUsername("  Thibaut  "))
            .thenReturn(mockUser);
        when(refactoredGameService.createGame(eq(testUserId), any(CreateGameRequest.class)))
            .thenReturn(createdGameDto);

        // When & Then
        mockMvc.perform(post("/api/games")
                .param("user", "  Thibaut  ")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(validGameRequest)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.name").value("Ma Première Game - TDD"));
    }

    @Test
    @DisplayName("Devrait retourner 401 quand ni l'authentification ni le paramètre ne sont disponibles")
    void shouldReturn401WhenNeitherAuthenticationNorParamAvailable() throws Exception {
        // Given
        // validateCreateGameRequest ne retourne rien (void) - il lance une exception si invalide
        when(userContextService.getCurrentUserWithFallback(null))
            .thenThrow(new UserNotFoundException("Utilisateur non authentifié et aucun fallback disponible"));

        // When & Then
        mockMvc.perform(post("/api/games")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(validGameRequest)))
            .andExpect(status().isUnauthorized());
    }

    @Test
    @DisplayName("Devrait valider le contenu JSON de la requête")
    void shouldValidateJsonContent() throws Exception {
        // Given
        CreateGameRequest invalidRequest = new CreateGameRequest(
            "", // Nom vide
            -1, // Nombre négatif
            "Description invalide",
            false,
            false,
            300,
            43200,
            2025
        );
        
        // Mock user même si le test devrait échouer en validation
        User mockUser = TestDataBuilder.createThibaut();
        mockUser.setId(testUserId);
        when(userContextService.findUserByUsername("Thibaut"))
            .thenReturn(mockUser);

        // When & Then
        mockMvc.perform(post("/api/games")
                .param("user", "Thibaut")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(invalidRequest)))
            .andExpect(status().isBadRequest());
    }

    @Test
    @DisplayName("Devrait créer une game avec des règles de région")
    void shouldCreateGameWithRegionRules() throws Exception {
        // Given
        CreateGameRequest requestWithRegions = new CreateGameRequest(
            "Game avec Règles Région",
            10,
            "Game avec règles de région spécifiques",
            false,
            false,
            300,
            43200,
            2025
        );
        requestWithRegions.addRegionRule(Player.Region.EU, 3);
        requestWithRegions.addRegionRule(Player.Region.NAC, 2);
        requestWithRegions.addRegionRule(Player.Region.BR, 2);

        // validateCreateGameRequest ne retourne rien (void) - il lance une exception si invalide
        User mockUser = TestDataBuilder.createThibaut();
        mockUser.setId(testUserId);
        when(userContextService.findUserByUsername("Thibaut"))
            .thenReturn(mockUser);
        when(refactoredGameService.createGame(eq(testUserId), any(CreateGameRequest.class)))
            .thenReturn(createdGameDto);

        // When & Then
        mockMvc.perform(post("/api/games")
                .param("user", "Thibaut")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(requestWithRegions)))
            .andExpect(status().isCreated())
            .andExpect(jsonPath("$.name").value("Ma Première Game - TDD"));
    }
} 